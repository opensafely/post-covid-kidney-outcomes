------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\lsh1703468\Documents\repos\logs/cox_esrd_2017.log
  log type:  text
 opened on:  10 Jan 2023, 20:19:37

. use ./output/analysis_2017.dta

. 
. stset exit_date, fail(esrd_date) origin(index_date) id(patient_id) scale(365.25)

Survival-time data settings

           ID variable: patient_id
         Failure event: esrd_date!=0 & esrd_date<.
Observed time interval: (exit_date[_n-1], exit_date]
     Exit on or before: failure
     Time for analysis: (time-origin)/365.25
                Origin: time index_date

--------------------------------------------------------------------------
     27,786  total observations
        126  observations end on or before enter()
         36  observations begin on or after (first) failure
--------------------------------------------------------------------------
     27,624  observations remaining, representing
     27,350  subjects
      2,648  failures in single-failure-per-subject data
 47,153.317  total analysis time at risk and under observation
                                                At risk from t =         0
                                     Earliest observed entry t =         0
                                          Last observed exit t =  5.744011

. foreach exposure of varlist     case                    ///
>                                                         covid_severity  ///
>                                                         covid_aki               ///
>                                                         covid_vax               ///
>                                                         calendar_period {
  2.         tab _d `exposure', col chi
  3.         strate `exposure'
  4.         stcox i.`exposure' i.sex age1 age2 age3, vce(cluster practice_id) strata(set_id)
  5.         quietly stcox i.`exposure' i.sex age1 age2 age3, strata(set_id)
  6.         est store A
  7.         quietly stcox i.sex age1 age2 age3, strata(set_id)
  8.         est store B
  9.         lrtest B A
 10.         stcox i.`exposure' i.sex i.ethnicity i.imd i.region i.urban i.bmi i.smoking age1 age2 age3, vce(cluster practice_id) strata(set_id)
 11.         quietly stcox i.`exposure' i.sex i.ethnicity i.imd i.region i.urban i.bmi i.smoking age1 age2 age3, strata(set_id)
 12.         est store A
 13.         quietly stcox i.sex i.ethnicity i.imd i.region i.urban i.bmi i.smoking age1 age2 age3, strata(set_id)
 14.         est store B
 15.         lrtest B A
 16.         stcox i.`exposure' i.sex i.ethnicity i.imd i.region i.urban i.bmi i.cardiovascular i.diabetes i.hypertension i.immunosuppressed i.non_haem_cancer i.smoking age1 age2 age3, vce(cluster practice_id) strata(set_id)
 17.         quietly stcox i.`exposure' i.sex i.ethnicity i.imd i.region i.urban i.bmi i.cardiovascular i.diabetes i.hypertension i.immunosuppressed i.non_haem_cancer i.smoking age1 age2 age3, strata(set_id)
 18.         est store A
 19.         quietly stcox i.sex i.ethnicity i.imd i.region i.urban i.bmi i.cardiovascular i.diabetes i.hypertension i.immunosuppressed i.non_haem_cancer i.smoking age1 age2 age3, strata(set_id)
 20.         est store B
 21.         lrtest B A
 22.         }

+-------------------+
| Key               |
|-------------------|
|     frequency     |
| column percentage |
+-------------------+

      1 if |
failure; 0 |
        if |         case
  censored | Comparato   COVID-19 |     Total
-----------+----------------------+----------
         0 |    17,841      7,135 |    24,976 
           |     90.41      90.43 |     90.41 
-----------+----------------------+----------
         1 |     1,893        755 |     2,648 
           |      9.59       9.57 |      9.59 
-----------+----------------------+----------
     Total |    19,734      7,890 |    27,624 
           |    100.00     100.00 |    100.00 

          Pearson chi2(1) =   0.0036   Pr = 0.952

        Failure _d: esrd_date
  Analysis time _t: (exit_date-origin)/365.25
            Origin: time index_date
       ID variable: patient_id

Estimated failure rates
Number of records = 27624

  +---------------------------------------------------------------------------+
  |                    case      D         Y       Rate      Lower      Upper |
  |---------------------------------------------------------------------------|
  | Comparator (historical)   1893   3.4e+04   0.056321   0.053840   0.058916 |
  |                COVID-19    755   1.4e+04   0.055751   0.051913   0.059873 |
  +---------------------------------------------------------------------------+
   Notes: Rate = D/Y = failures/person-time.
          Lower and Upper are bounds of 95% confidence intervals.


        Failure _d: esrd_date
  Analysis time _t: (exit_date-origin)/365.25
            Origin: time index_date
       ID variable: patient_id

Iteration 0:   log pseudolikelihood = -3128.9655
Iteration 1:   log pseudolikelihood = -3125.1956
Iteration 2:   log pseudolikelihood = -3125.1952
Refining estimates:
Iteration 0:   log pseudolikelihood = -3125.1952

Stratified Cox regression with Breslow method for ties
Strata variable: set_id

No. of subjects =      27,350                           Number of obs = 27,624
No. of failures =       2,648
Time at risk    = 47,153.3169
                                                        Wald chi2(4)  =  28.18
Log pseudolikelihood = -3125.1952                       Prob > chi2   = 0.0000

                           (Std. err. adjusted for 39 clusters in practice_id)
------------------------------------------------------------------------------
             |               Robust
          _t | Haz. ratio   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        case |
   COVID-19  |   1.018997   .0407964     0.47   0.638     .9420946    1.102178
             |
         sex |
       Male  |          1  (omitted)
        age1 |   1.014764   .0045224     3.29   0.001     1.005939    1.023666
        age2 |   .9731566   .0134917    -1.96   0.050     .9470695    .9999623
        age3 |   1.046546   .0421301     1.13   0.258     .9671464    1.132465
------------------------------------------------------------------------------

Likelihood-ratio test
Assumption: B nested within A

 LR chi2(1) =   0.17
Prob > chi2 = 0.6807

        Failure _d: esrd_date
  Analysis time _t: (exit_date-origin)/365.25
            Origin: time index_date
       ID variable: patient_id

Iteration 0:   log pseudolikelihood =  -56.85162
Iteration 1:   log pseudolikelihood = -36.508334
Iteration 2:   log pseudolikelihood = -33.059758
Iteration 3:   log pseudolikelihood = -31.986127
Iteration 4:   log pseudolikelihood = -31.784718
Iteration 5:   log pseudolikelihood = -31.776477
Iteration 6:   log pseudolikelihood = -31.776464
Refining estimates:
Iteration 0:   log pseudolikelihood = -31.776464

Stratified Cox regression with no ties
Strata variable: set_id

No. of subjects =      3,390                        Number of obs =      3,397
No. of failures =        328
Time at risk    = 5,856.3696
                                                    Wald chi2(19) = 2305108.17
Log pseudolikelihood = -31.776464                   Prob > chi2   =     0.0000

                                        (Std. err. adjusted for 34 clusters in practice_id)
-------------------------------------------------------------------------------------------
                          |               Robust
                       _t | Haz. ratio   std. err.      z    P>|z|     [95% conf. interval]
--------------------------+----------------------------------------------------------------
                     case |
                COVID-19  |   1.237555   .3232276     0.82   0.414     .7417299    2.064826
                          |
                      sex |
                    Male  |          1  (omitted)
                          |
                ethnicity |
             South Asian  |   .6329331   .6600568    -0.44   0.661     .0819745    4.886937
                   Black  |   .4792744   .4026343    -0.88   0.381     .0923628    2.486975
                   Mixed  |   4.876477    3.00439     2.57   0.010     1.457747    16.31286
                   Other  |   2.116371   1.363465     1.16   0.245     .5986986    7.481273
                          |
                      imd |
                       2  |   2.358942   1.951743     1.04   0.300     .4660685    11.93947
                       3  |   .3101104   .3278901    -1.11   0.268     .0390402    2.463317
                       4  |   11.05472   16.40146     1.62   0.105     .6034674    202.5079
        5 Least deprived  |   .4172505   .3387429    -1.08   0.282     .0849871    2.048524
                          |
                   region |
                    East  |   .6629026   1.395954    -0.20   0.845     .0106899    41.10811
                  London  |   .0325212    .027368    -4.07   0.000     .0062495    .1692351
              North East  |   .0080803   .0088306    -4.41   0.000     .0009488    .0688121
              North West  |   .2288454   .1815913    -1.86   0.063     .0483175    1.083877
              South East  |   2.322214   1.504232     1.30   0.193     .6524239    8.265605
              South West  |   .0809744   .0779734    -2.61   0.009     .0122657    .5345678
           West Midlands  |   .0151652   .0199662    -3.18   0.001     .0011486    .2002275
Yorkshire and The Humber  |   .0722331   .0760572    -2.50   0.013     .0091721    .5688552
                          |
                    urban |
                   Urban  |   .4696224   .2794235    -1.27   0.204     .1463145    1.507337
                          |
                      bmi |
      Normal (18.5-24.9)  |   114.4178   542.8842     1.00   0.318     .0104653     1250940
    Overweight (25-29.9)  |   462.8175    2375.71     1.20   0.232     .0197727    1.08e+07
       Obese I (30-34.9)  |   168.4808   902.1137     0.96   0.338     .0046653     6084485
      Obese II (35-39.9)  |   42.04491   222.0948     0.71   0.479     .0013409     1318364
         Obese III (40+)  |   676.4161   3441.178     1.28   0.200      .031611    1.45e+07
                          |
                  smoking |
   Current/former smoker  |   1.064828   .7377294     0.09   0.928     .2738761    4.140045
                     age1 |   .8390805   .0277087    -5.31   0.000     .7864925    .8951847
                     age2 |   1.783013   .3263639     3.16   0.002     1.245518     2.55246
                     age3 |   .1571043   .1074282    -2.71   0.007     .0411278    .6001243
-------------------------------------------------------------------------------------------

Likelihood-ratio test
Assumption: B nested within A

 LR chi2(1) =   0.12
Prob > chi2 = 0.7268

        Failure _d: esrd_date
  Analysis time _t: (exit_date-origin)/365.25
            Origin: time index_date
       ID variable: patient_id

Iteration 0:   log pseudolikelihood =  -56.85162
Iteration 1:   log pseudolikelihood = -30.886291
Iteration 2:   log pseudolikelihood = -23.124252
Iteration 3:   log pseudolikelihood = -17.440884
Iteration 4:   log pseudolikelihood = -12.840709
Iteration 5:   log pseudolikelihood = -11.352854
Iteration 6:   log pseudolikelihood = -11.168136
Iteration 7:   log pseudolikelihood = -11.152216  (backed up)
Iteration 8:   log pseudolikelihood = -11.144259  (backed up)
Iteration 9:   log pseudolikelihood = -11.141939  (backed up)
Iteration 10:  log pseudolikelihood = -11.141865  (backed up)
flat region resulting in a missing likelihood
r(430);

end of do-file

r(430);

. do "C:\Users\LSH170~1\AppData\Local\Temp\STD1a44_000000.tmp"

. *************************************************************************
. *Do file: 08_hhClassif_an_mv_analysis_perEth5Group_HR_table.do
. *
. *Purpose: Create content that is ready to paste into a pre-formatted Word 
. * shell table containing minimally and fully-adjusted HRs for risk factors
. * of interest, across 2 outcomes 
. *
. *Requires: final analysis dataset (analysis_dataset.dta)
. 
. *
. *Coding: K Wing, base on file from HFORBES, based on file from Krishnan Bhaskaran
. *
. *Date drafted: 17th June 2021
. *************************************************************************
. sysdir set PLUS ./analysis/adofiles

. sysdir set PERSONAL ./analysis/adofiles

. *run globals of lists of diagnoses and symptoms, then make loc
. do ./analysis/masterlists.do

. global outcome esrd_date egfr_half_date aki_date

. 
. global exposure case covid_severity covid_aki

. 
end of do-file

. 
. *checking tabulations
. capture log close
