version: "3.0"

expectations:
  population_size: 50000

actions:

# Extract data required for matching for covid (all STPs)
  extract_covid_matching:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_covid_matching
    outputs:
      highly_sensitive:
        cohort: output/input_covid_matching.csv

#Data management for covid_matching for matching with 2017 general population
  clean_covid_matching_2017:
    run: stata-mp:latest analysis/covid_matching_2017.do
    needs: [extract_covid_matching]
    outputs:
      highly_sensitive:
        analysis_dataset: output/covid_matching_2017.csv
      moderately_sensitive:
        log: logs/covid_matching_2017.log

#Extract data required for matching for 2017 (all STPs)
  extract_2017_matching:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2017_matching
    outputs:
      highly_sensitive:
        cohort: output/input_2017_matching.csv

#Data management for 2017_matching
  clean_2017_matching:
    run: stata-mp:latest analysis/2017_matching.do
    needs: [extract_2017_matching, clean_covid_matching_2017]
    outputs:
      highly_sensitive:
        analysis_dataset: output/2017_matching.csv
      moderately_sensitive:
        log: logs/2017_matching.log

# Split covid_matching_2017 and 2017_matching by STP
  split_stps_2017:
    run: stata-mp:latest analysis/split_stps_2017.do
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching]
    outputs:
      highly_sensitive:
        covid_stp5: output/input_covid_matching_2017_stp5.csv
        covid_stp6: output/input_covid_matching_2017_stp6.csv
        covid_stp7: output/input_covid_matching_2017_stp7.csv
        covid_stp8: output/input_covid_matching_2017_stp8.csv
        covid_stp9: output/input_covid_matching_2017_stp9.csv
        covid_stp10: output/input_covid_matching_2017_stp10.csv
        covid_stp12: output/input_covid_matching_2017_stp12.csv
        covid_stp13: output/input_covid_matching_2017_stp13.csv
        covid_stp14: output/input_covid_matching_2017_stp14.csv
        covid_stp15: output/input_covid_matching_2017_stp15.csv
        covid_stp16: output/input_covid_matching_2017_stp16.csv
        covid_stp17: output/input_covid_matching_2017_stp17.csv
        covid_stp20: output/input_covid_matching_2017_stp20.csv
        covid_stp21: output/input_covid_matching_2017_stp21.csv
        covid_stp22: output/input_covid_matching_2017_stp22.csv
        covid_stp23: output/input_covid_matching_2017_stp23.csv
        covid_stp24: output/input_covid_matching_2017_stp24.csv
        covid_stp25: output/input_covid_matching_2017_stp25.csv
        covid_stp26: output/input_covid_matching_2017_stp26.csv
        covid_stp27: output/input_covid_matching_2017_stp27.csv
        covid_stp29: output/input_covid_matching_2017_stp29.csv
        covid_stp33: output/input_covid_matching_2017_stp33.csv
        covid_stp35: output/input_covid_matching_2017_stp35.csv
        covid_stp36: output/input_covid_matching_2017_stp36.csv
        covid_stp37: output/input_covid_matching_2017_stp37.csv
        covid_stp40: output/input_covid_matching_2017_stp40.csv
        covid_stp41: output/input_covid_matching_2017_stp41.csv
        covid_stp42: output/input_covid_matching_2017_stp42.csv
        covid_stp43: output/input_covid_matching_2017_stp43.csv
        covid_stp44: output/input_covid_matching_2017_stp44.csv
        covid_stp49: output/input_covid_matching_2017_stp49.csv
        2017_stp5: output/input_2017_matching_stp5.csv
        2017_stp6: output/input_2017_matching_stp6.csv
        2017_stp7: output/input_2017_matching_stp7.csv
        2017_stp8: output/input_2017_matching_stp8.csv
        2017_stp9: output/input_2017_matching_stp9.csv
        2017_stp10: output/input_2017_matching_stp10.csv
        2017_stp12: output/input_2017_matching_stp12.csv
        2017_stp13: output/input_2017_matching_stp13.csv
        2017_stp14: output/input_2017_matching_stp14.csv
        2017_stp15: output/input_2017_matching_stp15.csv
        2017_stp16: output/input_2017_matching_stp16.csv
        2017_stp17: output/input_2017_matching_stp17.csv
        2017_stp20: output/input_2017_matching_stp20.csv
        2017_stp21: output/input_2017_matching_stp21.csv
        2017_stp22: output/input_2017_matching_stp22.csv
        2017_stp23: output/input_2017_matching_stp23.csv
        2017_stp24: output/input_2017_matching_stp24.csv
        2017_stp25: output/input_2017_matching_stp25.csv
        2017_stp26: output/input_2017_matching_stp26.csv
        2017_stp27: output/input_2017_matching_stp27.csv
        2017_stp29: output/input_2017_matching_stp29.csv
        2017_stp33: output/input_2017_matching_stp33.csv
        2017_stp35: output/input_2017_matching_stp35.csv
        2017_stp36: output/input_2017_matching_stp36.csv
        2017_stp37: output/input_2017_matching_stp37.csv
        2017_stp40: output/input_2017_matching_stp40.csv
        2017_stp41: output/input_2017_matching_stp41.csv
        2017_stp42: output/input_2017_matching_stp42.csv
        2017_stp43: output/input_2017_matching_stp43.csv
        2017_stp44: output/input_2017_matching_stp44.csv
        2017_stp49: output/input_2017_matching_stp49.csv
      moderately_sensitive:
        log: logs/split_stps_2017.log

  match_2017_stp5:
    run: python:latest python analysis/match_2017_stp5.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp5: output/matching_report_2017_stp5.txt
      highly_sensitive:
        matched_matches_stp5: output/matched_matches_2017_stp5.csv
        matched_cases_stp5: output/matched_cases_2017_stp5.csv
        matched_all_stp5: output/matched_combined_2017_stp5.csv

  match_2017_stp6:
    run: python:latest python analysis/match_2017_stp6.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp6: output/matching_report_2017_stp6.txt
      highly_sensitive:
        matched_matches_stp6: output/matched_matches_2017_stp6.csv
        matched_cases_stp6: output/matched_cases_2017_stp6.csv
        matched_all_stp6: output/matched_combined_2017_stp6.csv

  match_2017_stp7:
    run: python:latest python analysis/match_2017_stp7.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp7: output/matching_report_2017_stp7.txt
      highly_sensitive:
        matched_matches_stp7: output/matched_matches_2017_stp7.csv
        matched_cases_stp7: output/matched_cases_2017_stp7.csv
        matched_all_stp7: output/matched_combined_2017_stp7.csv

  match_2017_stp8:
    run: python:latest python analysis/match_2017_stp8.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp8: output/matching_report_2017_stp8.txt
      highly_sensitive:
        matched_matches_stp8: output/matched_matches_2017_stp8.csv
        matched_cases_stp8: output/matched_cases_2017_stp8.csv
        matched_all_stp8: output/matched_combined_2017_stp8.csv

  match_2017_stp9:
    run: python:latest python analysis/match_2017_stp9.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp9: output/matching_report_2017_stp9.txt
      highly_sensitive:
        matched_matches_stp9: output/matched_matches_2017_stp9.csv
        matched_cases_stp9: output/matched_cases_2017_stp9.csv
        matched_all_stp9: output/matched_combined_2017_stp9.csv

  match_2017_stp10:
    run: python:latest python analysis/match_2017_stp10.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp10: output/matching_report_2017_stp10.txt
      highly_sensitive:
        matched_matches_stp10: output/matched_matches_2017_stp10.csv
        matched_cases_stp10: output/matched_cases_2017_stp10.csv
        matched_all_stp10: output/matched_combined_2017_stp10.csv

  match_2017_stp12:
    run: python:latest python analysis/match_2017_stp12.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp12: output/matching_report_2017_stp12.txt
      highly_sensitive:
        matched_matches_stp12: output/matched_matches_2017_stp12.csv
        matched_cases_stp12: output/matched_cases_2017_stp12.csv
        matched_all_stp12: output/matched_combined_2017_stp12.csv

  match_2017_stp13:
    run: python:latest python analysis/match_2017_stp13.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp13: output/matching_report_2017_stp13.txt
      highly_sensitive:
        matched_matches_stp13: output/matched_matches_2017_stp13.csv
        matched_cases_stp13: output/matched_cases_2017_stp13.csv
        matched_all_stp13: output/matched_combined_2017_stp13.csv

  match_2017_stp14:
    run: python:latest python analysis/match_2017_stp14.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp14: output/matching_report_2017_stp14.txt
      highly_sensitive:
        matched_matches_stp14: output/matched_matches_2017_stp14.csv
        matched_cases_stp14: output/matched_cases_2017_stp14.csv
        matched_all_stp14: output/matched_combined_2017_stp14.csv

  match_2017_stp15:
    run: python:latest python analysis/match_2017_stp15.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp15: output/matching_report_2017_stp15.txt
      highly_sensitive:
        matched_matches_stp15: output/matched_matches_2017_stp15.csv
        matched_cases_stp15: output/matched_cases_2017_stp15.csv
        matched_all_stp15: output/matched_combined_2017_stp15.csv

  match_2017_stp16:
    run: python:latest python analysis/match_2017_stp16.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp16: output/matching_report_2017_stp16.txt
      highly_sensitive:
        matched_matches_stp16: output/matched_matches_2017_stp16.csv
        matched_cases_stp16: output/matched_cases_2017_stp16.csv
        matched_all_stp16: output/matched_combined_2017_stp16.csv

  match_2017_stp17:
    run: python:latest python analysis/match_2017_stp17.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp17: output/matching_report_2017_stp17.txt
      highly_sensitive:
        matched_matches_stp17: output/matched_matches_2017_stp17.csv
        matched_cases_stp17: output/matched_cases_2017_stp17.csv
        matched_all_stp17: output/matched_combined_2017_stp17.csv

  match_2017_stp20:
    run: python:latest python analysis/match_2017_stp20.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp20: output/matching_report_2017_stp20.txt
      highly_sensitive:
        matched_matches_stp20: output/matched_matches_2017_stp20.csv
        matched_cases_stp20: output/matched_cases_2017_stp20.csv
        matched_all_stp20: output/matched_combined_2017_stp20.csv

  match_2017_stp21:
    run: python:latest python analysis/match_2017_stp21.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp21: output/matching_report_2017_stp21.txt
      highly_sensitive:
        matched_matches_stp21: output/matched_matches_2017_stp21.csv
        matched_cases_stp21: output/matched_cases_2017_stp21.csv
        matched_all_stp21: output/matched_combined_2017_stp21.csv

  match_2017_stp22:
    run: python:latest python analysis/match_2017_stp22.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp22: output/matching_report_2017_stp22.txt
      highly_sensitive:
        matched_matches_stp22: output/matched_matches_2017_stp22.csv
        matched_cases_stp22: output/matched_cases_2017_stp22.csv
        matched_all_stp22: output/matched_combined_2017_stp22.csv

  match_2017_stp23:
    run: python:latest python analysis/match_2017_stp23.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp23: output/matching_report_2017_stp23.txt
      highly_sensitive:
        matched_matches_stp23: output/matched_matches_2017_stp23.csv
        matched_cases_stp23: output/matched_cases_2017_stp23.csv
        matched_all_stp23: output/matched_combined_2017_stp23.csv

  match_2017_stp24:
    run: python:latest python analysis/match_2017_stp24.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp24: output/matching_report_2017_stp24.txt
      highly_sensitive:
        matched_matches_stp24: output/matched_matches_2017_stp24.csv
        matched_cases_stp24: output/matched_cases_2017_stp24.csv
        matched_all_stp24: output/matched_combined_2017_stp24.csv

  match_2017_stp25:
    run: python:latest python analysis/match_2017_stp25.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp25: output/matching_report_2017_stp25.txt
      highly_sensitive:
        matched_matches_stp25: output/matched_matches_2017_stp25.csv
        matched_cases_stp25: output/matched_cases_2017_stp25.csv
        matched_all_stp25: output/matched_combined_2017_stp25.csv

  match_2017_stp26:
    run: python:latest python analysis/match_2017_stp26.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp26: output/matching_report_2017_stp26.txt
      highly_sensitive:
        matched_matches_stp26: output/matched_matches_2017_stp26.csv
        matched_cases_stp26: output/matched_cases_2017_stp26.csv
        matched_all_stp26: output/matched_combined_2017_stp26.csv

  match_2017_stp27:
    run: python:latest python analysis/match_2017_stp27.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp27: output/matching_report_2017_stp27.txt
      highly_sensitive:
        matched_matches_stp27: output/matched_matches_2017_stp27.csv
        matched_cases_stp27: output/matched_cases_2017_stp27.csv
        matched_all_stp27: output/matched_combined_2017_stp27.csv

  match_2017_stp29:
    run: python:latest python analysis/match_2017_stp29.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp29: output/matching_report_2017_stp29.txt
      highly_sensitive:
        matched_matches_stp29: output/matched_matches_2017_stp29.csv
        matched_cases_stp29: output/matched_cases_2017_stp29.csv
        matched_all_stp29: output/matched_combined_2017_stp29.csv

  match_2017_stp33:
    run: python:latest python analysis/match_2017_stp33.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp33: output/matching_report_2017_stp33.txt
      highly_sensitive:
        matched_matches_stp33: output/matched_matches_2017_stp33.csv
        matched_cases_stp33: output/matched_cases_2017_stp33.csv
        matched_all_stp33: output/matched_combined_2017_stp33.csv

  match_2017_stp35:
    run: python:latest python analysis/match_2017_stp35.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp35: output/matching_report_2017_stp35.txt
      highly_sensitive:
        matched_matches_stp35: output/matched_matches_2017_stp35.csv
        matched_cases_stp35: output/matched_cases_2017_stp35.csv
        matched_all_stp35: output/matched_combined_2017_stp35.csv

  match_2017_stp36:
    run: python:latest python analysis/match_2017_stp36.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp36: output/matching_report_2017_stp36.txt
      highly_sensitive:
        matched_matches_stp36: output/matched_matches_2017_stp36.csv
        matched_cases_stp36: output/matched_cases_2017_stp36.csv
        matched_all_stp36: output/matched_combined_2017_stp36.csv

  match_2017_stp37:
    run: python:latest python analysis/match_2017_stp37.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp37: output/matching_report_2017_stp37.txt
      highly_sensitive:
        matched_matches_stp37: output/matched_matches_2017_stp37.csv
        matched_cases_stp37: output/matched_cases_2017_stp37.csv
        matched_all_stp37: output/matched_combined_2017_stp37.csv

  match_2017_stp40:
    run: python:latest python analysis/match_2017_stp40.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp40: output/matching_report_2017_stp40.txt
      highly_sensitive:
        matched_matches_stp40: output/matched_matches_2017_stp40.csv
        matched_cases_stp40: output/matched_cases_2017_stp40.csv
        matched_all_stp40: output/matched_combined_2017_stp40.csv

  match_2017_stp41:
    run: python:latest python analysis/match_2017_stp41.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp41: output/matching_report_2017_stp41.txt
      highly_sensitive:
        matched_matches_stp41: output/matched_matches_2017_stp41.csv
        matched_cases_stp41: output/matched_cases_2017_stp41.csv
        matched_all_stp41: output/matched_combined_2017_stp41.csv

  match_2017_stp42:
    run: python:latest python analysis/match_2017_stp42.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp42: output/matching_report_2017_stp42.txt
      highly_sensitive:
        matched_matches_stp42: output/matched_matches_2017_stp42.csv
        matched_cases_stp42: output/matched_cases_2017_stp42.csv
        matched_all_stp42: output/matched_combined_2017_stp42.csv

  match_2017_stp43:
    run: python:latest python analysis/match_2017_stp43.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp43: output/matching_report_2017_stp43.txt
      highly_sensitive:
        matched_matches_stp43: output/matched_matches_2017_stp43.csv
        matched_cases_stp43: output/matched_cases_2017_stp43.csv
        matched_all_stp43: output/matched_combined_2017_stp43.csv

  match_2017_stp44:
    run: python:latest python analysis/match_2017_stp44.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp44: output/matching_report_2017_stp44.txt
      highly_sensitive:
        matched_matches_stp44: output/matched_matches_2017_stp44.csv
        matched_cases_stp44: output/matched_cases_2017_stp44.csv
        matched_all_stp44: output/matched_combined_2017_stp44.csv

  match_2017_stp49:
    run: python:latest python analysis/match_2017_stp49.py
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017]
    outputs:
      moderately_sensitive:
        matching_report_stp49: output/matching_report_2017_stp49.txt
      highly_sensitive:
        matched_matches_stp49: output/matched_matches_2017_stp49.csv
        matched_cases_stp49: output/matched_cases_2017_stp49.csv
        matched_all_stp49: output/matched_combined_2017_stp49.csv

  combine_stps_covid_2017:
    run: stata-mp:latest analysis/combine_stps_covid_2017.do
    needs: [match_2017_stp5, match_2017_stp6, match_2017_stp7, match_2017_stp8, match_2017_stp9,
    match_2017_stp10, match_2017_stp12, match_2017_stp13, match_2017_stp14, match_2017_stp15,
    match_2017_stp16, match_2017_stp17, match_2017_stp20, match_2017_stp21, match_2017_stp22,
    match_2017_stp23, match_2017_stp24, match_2017_stp25, match_2017_stp26, match_2017_stp27,
    match_2017_stp29, match_2017_stp33, match_2017_stp35, match_2017_stp36, match_2017_stp37, 
    match_2017_stp40, match_2017_stp41, match_2017_stp42, match_2017_stp43, match_2017_stp44, 
    match_2017_stp49]
    outputs:
      highly_sensitive:
        matched_cases_combined: output/input_combined_stps_covid_2017.csv
      moderately_sensitive:
        log: logs/combine_stps_covid_2017.log

  combine_stps_matches_2017:
    run: stata-mp:latest analysis/combine_stps_matches_2017.do
    needs: [match_2017_stp5, match_2017_stp6, match_2017_stp7, match_2017_stp8, match_2017_stp9,
    match_2017_stp10, match_2017_stp12, match_2017_stp13, match_2017_stp14, match_2017_stp15,
    match_2017_stp16, match_2017_stp17, match_2017_stp20, match_2017_stp21, match_2017_stp22,
    match_2017_stp23, match_2017_stp24, match_2017_stp25, match_2017_stp26, match_2017_stp27,
    match_2017_stp29, match_2017_stp33, match_2017_stp35, match_2017_stp36, match_2017_stp37, 
    match_2017_stp40, match_2017_stp41, match_2017_stp42, match_2017_stp43, match_2017_stp44, 
    match_2017_stp49]
    outputs:
      highly_sensitive:
        matched_matches_combined: output/input_combined_stps_matches_2017.csv
      moderately_sensitive:
        log: logs/combine_stps_matches_2017.log

  extract_covid_2017_additional:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_covid_2017_additional 
    needs: [combine_stps_covid_2017]
    outputs:
      highly_sensitive:
        cohort: output/input_covid_2017_additional.csv

  extract_2017_additional:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_2017_additional 
    needs: [combine_stps_matches_2017]
    outputs:
      highly_sensitive:
        cohort: output/input_2017_additional.csv

  codebook_2017_additional:
    run: stata-mp:latest analysis/codebook_2017_additional.do
    needs: [extract_covid_2017_additional, extract_2017_additional]
    outputs:
      moderately_sensitive:
        log: logs/codebook_2017_additional.log

  analysis_2017:
    run: stata-mp:latest analysis/analysis_2017.do
    needs: [extract_covid_matching, clean_covid_matching_2017, extract_2017_matching, clean_2017_matching, split_stps_2017, match_2017_stp5, match_2017_stp6, match_2017_stp7, match_2017_stp8, match_2017_stp9, match_2017_stp10, match_2017_stp12, match_2017_stp13, match_2017_stp14, match_2017_stp15, match_2017_stp16, match_2017_stp17, match_2017_stp20, match_2017_stp21, match_2017_stp22, match_2017_stp23, match_2017_stp24, match_2017_stp25, match_2017_stp26, match_2017_stp27, match_2017_stp29, match_2017_stp33, match_2017_stp35, match_2017_stp36, match_2017_stp37, match_2017_stp40, match_2017_stp41, match_2017_stp42, match_2017_stp43, match_2017_stp44, match_2017_stp49, combine_stps_covid_2017, combine_stps_matches_2017, extract_covid_2017_additional, extract_2017_additional]
    outputs:
      highly_sensitive:
        analysis: output/analysis_2017.dta
      moderately_sensitive:
        log: logs/analysis_2017.log

  extract_covid_hospitalised:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_covid_hospitalised
    outputs:
      highly_sensitive:
        cohort: output/input_covid_hospitalised.csv

  extract_pneumonia_hospitalised:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_pneumonia_hospitalised
    outputs:
      highly_sensitive:
        cohort: output/input_pneumonia_hospitalised.csv

  analysis_hospitalised:
    run: stata-mp:latest analysis/analysis_hospitalised.do
    needs: [extract_covid_hospitalised, extract_pneumonia_hospitalised]
    outputs:
      highly_sensitive:
        analysis: output/analysis_hospitalised.dta
      moderately_sensitive:
        log: logs/analysis_hospitalised.log

  cox_2017_case:
    run: stata-mp:latest analysis/cox_2017_case.do
    needs: [analysis_2017]
    outputs:
      moderately_sensitive:
        log: logs/cox_2017_case.log
        output: output/cox_2017_case.txt

  cox_2017_covid_severity:
    run: stata-mp:latest analysis/cox_2017_covid_severity.do
    needs: [analysis_2017]
    outputs:
      moderately_sensitive:
        log: logs/cox_2017_covid_severity.log
        output: output/cox_2017_covid_severity.txt

  cox_2017_covid_aki:
    run: stata-mp:latest analysis/cox_2017_covid_aki.do
    needs: [analysis_2017]
    outputs:
      moderately_sensitive:
        log: logs/cox_2017_covid_aki.log
        output: output/cox_2017_covid_aki.txt

  cox_2017_covid_vax:
    run: stata-mp:latest analysis/cox_2017_covid_vax.do
    needs: [analysis_2017]
    outputs:
      moderately_sensitive:
        log: logs/cox_2017_covid_vax.log
        output: output/cox_2017_covid_vax.txt

  cox_2017_wave:
    run: stata-mp:latest analysis/cox_2017_wave.do
    needs: [analysis_2017]
    outputs:
      moderately_sensitive:
        log: logs/cox_2017_wave.log
        output: output/cox_2017_wave.txt

  cox_hospitalised_case:
    run: stata-mp:latest analysis/cox_hospitalised_case.do
    needs: [analysis_hospitalised]
    outputs:
      moderately_sensitive:
        log: logs/cox_hospitalised_case.log
        output: output/cox_hospitalised_case.txt

  cox_hospitalised_covid_vax:
    run: stata-mp:latest analysis/cox_hospitalised_covid_vax.do
    needs: [analysis_hospitalised]
    outputs:
      moderately_sensitive:
        log: logs/cox_hospitalised_covid_vax.log
        output: output/cox_hospitalised_covid_vax.txt

  cox_hospitalised_wave:
    run: stata-mp:latest analysis/cox_hospitalised_wave.do
    needs: [analysis_hospitalised]
    outputs:
      moderately_sensitive:
        log: logs/cox_hospitalised_wave.log
        output: output/cox_hospitalised_wave.txt

  cox_hospitalised_case_interactions:
    run: stata-mp:latest analysis/cox_hospitalised_case_interactions.do
    needs: [analysis_hospitalised]
    outputs:
      moderately_sensitive:
        log: logs/cox_hospitalised_case_interactions.log
        output: output/cox_hospitalised_case_interactions.txt